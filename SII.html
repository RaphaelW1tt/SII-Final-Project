<!DOCTYPE html>

<html>

  <head>
    <!-- INFORMATION
    To get this example application running, make sure to enable CORS on your local geosever by editing the WEB.XML file.
    Without doing this the application is not working!
    -->

    <!-- Encoding -->
    <meta charset="UTF-8">
    <!-- Description of Web Page -->
    <meta name="description" content="SII Final Project">
    <!-- Keywords important for Google -->
    <meta name="keywords" content="Akhil Patil, Pramit Ghosh, Shenaha Savikumar, Raphael Witt, Zhendong Yuan, Geoinformatics, Students">
    <!-- Author -->
    <meta name="author" content="Akhil Patil, Pramit Ghosh, Shenaha Savikumar, Raphael Witt, Zhendong Yuan">
    <!-- Title -->
    <title>SII - Final project</title>
    <!-- Implementing Leaflet resources and AJAX -->
	  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Style -->
    <style>
  	#mapid {
  	  height: 450px;
      width: 50%;
      border-radius: 10px;
      border-style: solid;
      border-color: gray;
      border-width: 0.1 px;
      position: absolute;
      top: 20%;
      margin-left: 25%;
      margin-right: 25%;
  	}
    hr {
  		display: block;
  		margin-left: auto;
  		margin-right: auto;
  		border-style: solid;
  		border-width: 2 px;
      color: gray;
    }
    #left {
      position: absolute;
      margin-left: 7%;
      margin-top: 10%;
    }
    #button {
      position: absolute;
      margin-left: 20%;
      margin-top: 15%;
    }
    .buttonstyle {
      width: 100px;
      height: 35px;
      border-radius: 10px;
    }
    #startdate {
      border: 1px solid gray;
      padding:.75em 1em .5em 1em;
      background-color: gray;
      color:white;
      margin-left: 20%;
      margin-top: 15%;
    }
    </style>

    </head>

    <body>

    <!-- Heading -->
    <h1 style="text-align:center;font-family: sans-serif">Visualisation of crimes in London</h1>

    <hr></hr>

    <!-- Controlpanel with selection and buttons -->
    <div id="left">
        <select name="startdate" id="startdate" >
            <option value="2017-04-01" selected="selected">2017-04</option>
            <option value="2017-03-01">2017-03</option>
            <option value="2017-02-01">2017-02</option>
            <option value="2017-01-01">2017-01</option>
            <option value="2016-12-01">2016-12</option>
            <option value="2016-11-01">2016-11</option>
            <option value="2016-10-01">2016-10</option>
            <option value="2016-09-01">2016-09</option>
            <option value="2016-08-01">2016-08</option>
            <option value="2016-07-01">2016-07</option>
            <option value="2016-06-01">2016-06</option>
            <option value="2016-05-01">2016-05</option>
            <option value="2016-04-01">2016-04</option>
        </select>
        <div id="button">
          <button id="showdata" class="buttonstyle">Show Data</button>
          <br>
          <br>
          <button id="removedata" class="buttonstyle" onclick="removeData()">Remove Data</button>
        </div>
    </div>

    <!-- Div container for map -->
    <div id="mapid"></div>

    <!-- JavaScript -->
    <script>

	  //Creating map
    var mymap = L.map('mapid', {zoomControl:true}).setView([51.5197230, -0.098044], 13);
    mymap.zoomControl.setPosition('bottomleft');

     //Adding a tile layer from OSM
    var osmmap =  L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
      }).addTo(mymap);

    //Using geoserver for retrieving map tiles
    var wmsLayer = L.tileLayer.wms('https://demo.boundlessgeo.com/geoserver/ows?', {
        layers: 'ne:ne'
    }).addTo(mymap);

    //Basemap and overlaymap for Layer control
    var baseMaps = {
      "Grayscale": wmsLayer
    };
    var overlayMaps = {
      "Streetmap": osmmap,
    };
    //Adding layer control to switch enable overlay
    L.control.layers(baseMaps, overlayMaps).addTo(mymap);


    //Creating layer 'crimes'
    var crimes = new L.GeoJSON();

    //On success and if the layer is not already added to the map, add the data to the layer crimes
    function loadGeoJson(data) {
      if (mymap.hasLayer(crimes)) {
        return false;
      } else {
        crimes.addData(data);
        mymap.addLayer(crimes);
      }
    };

    //On button "showdata" is clicked, retrieve data from the local geoserver
    $("#showdata").click(function(){
      start = document.getElementById("startdate");
      $.ajax({
        url: "http://localhost:8080/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=cite:crimes&propertyName=Month,the_geom,Crime_ID,Location,Crime_type&CQL_FILTER=Month=%27" + start.value + "%27&outputFormat=application/json",
        jsonCallback: 'getJson',
        success: loadGeoJson
      });
    });

    //Function to remove the layer
    function removeData(){
      mymap.removeLayer(crimes);
    }

    </script>

    </body>

</html>
